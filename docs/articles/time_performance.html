<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>performance • clasifierrr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="performance">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">clasifierrr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/alternative_classifiers.html">alternative_classifiers</a>
    </li>
    <li>
      <a href="../articles/classification_performance.html">classification_performance</a>
    </li>
    <li>
      <a href="../articles/features.html">features</a>
    </li>
    <li>
      <a href="../articles/time_performance.html">performance</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>performance</h1>
            
      
      
      <div class="hidden name"><code>time_performance.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Sometimes processing images is computtionally expensive, more noticeably … slow, this vignette tries to show the ways in which image processing can be accelerated.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(clasifierrr)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(EBImage)</a></code></pre></div>
<p>We will start with the same files as the ones in the readme</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">params_df &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="dt">file =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb2-3" title="3">        <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(</a>
<a class="sourceLine" id="cb2-4" title="4">            <span class="st">"extdata"</span>, <span class="st">"tiny_4T1-shNT-1_layer1.png"</span>,</a>
<a class="sourceLine" id="cb2-5" title="5">            <span class="dt">package =</span> <span class="st">"clasifierrr"</span>),</a>
<a class="sourceLine" id="cb2-6" title="6">        <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(</a>
<a class="sourceLine" id="cb2-7" title="7">            <span class="st">"extdata"</span>, <span class="st">"tiny_4T1-shNT-1_layer2.png"</span>,</a>
<a class="sourceLine" id="cb2-8" title="8">            <span class="dt">package =</span> <span class="st">"clasifierrr"</span>)),</a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="dt">classif =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"spheroid"</span>, <span class="st">"bg"</span>),</a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="dt">related_file =</span> <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(</a>
<a class="sourceLine" id="cb2-11" title="11">        <span class="st">"extdata"</span>, <span class="st">"tiny_4T1-shNT-1.png"</span>,</a>
<a class="sourceLine" id="cb2-12" title="12">        <span class="dt">package =</span> <span class="st">"clasifierrr"</span>)</a>
<a class="sourceLine" id="cb2-13" title="13">)</a>
<a class="sourceLine" id="cb2-14" title="14"></a>
<a class="sourceLine" id="cb2-15" title="15">params_df</a>
<a class="sourceLine" id="cb2-16" title="16"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="co">#&gt;   file                              classif related_file                        </span></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="co">#&gt;   &lt;chr&gt;                             &lt;chr&gt;   &lt;chr&gt;                               </span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="co">#&gt; 1 /tmp/Rtmpj1ueSh/temp_libpath734f… sphero… /tmp/Rtmpj1ueSh/temp_libpath734f364…</span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="co">#&gt; 2 /tmp/Rtmpj1ueSh/temp_libpath734f… bg      /tmp/Rtmpj1ueSh/temp_libpath734f364…</span></a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">base_image &lt;-<span class="st"> </span><span class="kw"><a href="../reference/readImageBw.html">readImageBw</a></span>(params_df[[<span class="dv">3</span>]][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw"><a href="https://rdrr.io/pkg/EBImage/man/display.html">display</a></span>(base_image, <span class="dt">method =</span> <span class="st">"raster"</span>)</a></code></pre></div>
<p><img src="time_performance_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div id="image-pre-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#image-pre-processing" class="anchor"></a>Image Pre-processing</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">time_taken_full &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb4-2" title="2">    features &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_features.html">calc_features</a></span>(</a>
<a class="sourceLine" id="cb4-3" title="3">        base_image, </a>
<a class="sourceLine" id="cb4-4" title="4">        <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>), <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">51</span>, <span class="dv">101</span>))</a>
<a class="sourceLine" id="cb4-5" title="5">})</a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; Attaching package: 'purrr'</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#&gt; The following object is masked from 'package:EBImage':</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt;     transpose</span></a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">time_taken_full</a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="co">#&gt;   0.545   0.080   0.662</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="kw"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span>(features)</a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt; 2527752 bytes</span></a></code></pre></div>
<p>we can notice that it takes 0.662 seconds to achieve the calculation and the <code>features</code> object ocupies 2.4 Mb.</p>
<p>Nonetheless, since we basically are doing one calculation per pixels, per filter, decreasing the number of pixels would decrease the number of calculation by that number. And therefore, decreasing the size will accelerate the speed with the square of that reduction (since its a 2d image)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">newsize &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(base_image)<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">shrunk_image &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/EBImage/man/spatial.html">resize</a></span>(base_image, <span class="dt">w =</span> newsize)</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4">time_taken_shrunk &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb5-5" title="5">    shrunk_features &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_features.html">calc_features</a></span>(</a>
<a class="sourceLine" id="cb5-6" title="6">        shrunk_image, </a>
<a class="sourceLine" id="cb5-7" title="7">        <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>), <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">15</span>, <span class="dv">31</span>))</a>
<a class="sourceLine" id="cb5-8" title="8">})</a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10">time_taken_shrunk</a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co">#&gt;   0.067   0.000   0.069</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="kw"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span>(shrunk_features)</a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co">#&gt; 359432 bytes</span></a></code></pre></div>
<p>we can notice that now it takes 0.069 seconds to achieve the calculation and the <code>shrunk_features</code> object ocupies 0.3 Mb.</p>
<p>which is a 9.5942029 fold decrease in time and 7.0326293 decrease in used memmory</p>
<p>lets take a look at the actual filters …</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="../reference/display_filters.html">display_filters</a></span>(shrunk_features, <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(shrunk_image), <span class="dt">scale =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="time_performance_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="../reference/display_filters.html">display_filters</a></span>(features, <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(base_image), <span class="dt">scale =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="time_performance_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<p>Note how, since the filter sizes are still the same, but the image size is different, the filters have slightly different effects.</p>
<p>now … I have implemented a way to make this automatic for the multiple case set.</p>
<p>For that you need to write a function that does the processing you want and pass it as an argument to <code>preprocess_fun_img</code> and <code>preprocess_fun_mask</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">half_image &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb8-2" title="2">    newsize &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(x)<span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-3" title="3">    shrunk_image &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/EBImage/man/spatial.html">resize</a></span>(x, <span class="dt">w =</span> newsize)</a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(shrunk_image)</a>
<a class="sourceLine" id="cb8-5" title="5">}</a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">multi_time_full &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb9-2" title="2">    trainset &lt;-<span class="st"> </span><span class="kw"><a href="../reference/build_train_multi.html">build_train_multi</a></span>(</a>
<a class="sourceLine" id="cb9-3" title="3">        params_df, </a>
<a class="sourceLine" id="cb9-4" title="4">        <span class="dt">train_size_each =</span> <span class="dv">5000</span>, </a>
<a class="sourceLine" id="cb9-5" title="5">        <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb9-6" title="6">})</a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">#&gt; Returning for file:  /tmp/Rtmpj1ueSh/temp_libpath734f364a36a4/clasifierrr/extdata/tiny_4T1-shNT-1_layer1.png and classification" spheroid " a total of { 8556 } positive pixels</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">#&gt; Returning for file:  /tmp/Rtmpj1ueSh/temp_libpath734f364a36a4/clasifierrr/extdata/tiny_4T1-shNT-1_layer2.png and classification" bg " a total of { 14056 } positive pixels</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">#&gt; Classified objects are of classes {bg: 3156} and {spheroid: 1844}</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">#&gt; Returning a data frame of 5000 rows and 11 columns</span></a>
<a class="sourceLine" id="cb9-11" title="11"></a>
<a class="sourceLine" id="cb9-12" title="12">multi_time_shrunk &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb9-13" title="13">    trainset &lt;-<span class="st"> </span><span class="kw"><a href="../reference/build_train_multi.html">build_train_multi</a></span>(</a>
<a class="sourceLine" id="cb9-14" title="14">        params_df, </a>
<a class="sourceLine" id="cb9-15" title="15">        <span class="dt">preprocess_fun_img =</span> half_image,</a>
<a class="sourceLine" id="cb9-16" title="16">        <span class="dt">preprocess_fun_mask =</span> half_image, </a>
<a class="sourceLine" id="cb9-17" title="17">        <span class="dt">train_size_each =</span> <span class="dv">5000</span>, </a>
<a class="sourceLine" id="cb9-18" title="18">        <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>), <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">15</span>, <span class="dv">31</span>))</a>
<a class="sourceLine" id="cb9-19" title="19">})</a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">#&gt; Returning for file:  /tmp/Rtmpj1ueSh/temp_libpath734f364a36a4/clasifierrr/extdata/tiny_4T1-shNT-1_layer1.png and classification" spheroid " a total of { 1382 } positive pixels</span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co">#&gt; Returning for file:  /tmp/Rtmpj1ueSh/temp_libpath734f364a36a4/clasifierrr/extdata/tiny_4T1-shNT-1_layer2.png and classification" bg " a total of { 2171 } positive pixels</span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="co">#&gt; Warning in build_train(feat_img = calc_features(preprocess_fun_img(readImageBw(.x)), : The selected train size(5000) is larger than the number of classified pixels (3541)  so the number is getting updated to the total number of available pixels</span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co">#&gt; Classified objects are of classes {bg: 2171} and {spheroid: 1370}</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="co">#&gt; Returning a data frame of 3541 rows and 11 columns</span></a>
<a class="sourceLine" id="cb9-25" title="25"></a>
<a class="sourceLine" id="cb9-26" title="26">multi_time_full</a>
<a class="sourceLine" id="cb9-27" title="27"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb9-28" title="28"><span class="co">#&gt;   0.282   0.000   0.286</span></a>
<a class="sourceLine" id="cb9-29" title="29">multi_time_shrunk</a>
<a class="sourceLine" id="cb9-30" title="30"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb9-31" title="31"><span class="co">#&gt;   0.220   0.000   0.231</span></a>
<a class="sourceLine" id="cb9-32" title="32"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(trainset)</a>
<a class="sourceLine" id="cb9-33" title="33"><span class="co">#&gt;   gauss_filt_3 gauss_filt_5    DoG_filt_3    DoG_filt_5   var_filt_3</span></a>
<a class="sourceLine" id="cb9-34" title="34"><span class="co">#&gt; 1   0.04705882   0.04708729 -1.527238e-11  2.846708e-05 7.160083e-06</span></a>
<a class="sourceLine" id="cb9-35" title="35"><span class="co">#&gt; 2   0.29444957   0.29151761 -4.254065e-10 -2.931952e-03 6.400751e-03</span></a>
<a class="sourceLine" id="cb9-36" title="36"><span class="co">#&gt; 3   0.35889114   0.35376300 -8.242000e-10 -5.128141e-03 2.342310e-03</span></a>
<a class="sourceLine" id="cb9-37" title="37"><span class="co">#&gt; 4   0.05098039   0.05108247  1.412226e-11  1.020745e-04 4.186785e-07</span></a>
<a class="sourceLine" id="cb9-38" title="38"><span class="co">#&gt; 5   0.44913640   0.45466559  9.397189e-10  5.529192e-03 3.631790e-04</span></a>
<a class="sourceLine" id="cb9-39" title="39"><span class="co">#&gt; 6   0.36009764   0.35933889 -3.195697e-10 -7.587559e-04 2.588423e-03</span></a>
<a class="sourceLine" id="cb9-40" title="40"><span class="co">#&gt;     var_filt_5 sobel_filt_3 sobel_filt_5 c_hough_trans_15 c_hough_trans_31</span></a>
<a class="sourceLine" id="cb9-41" title="41"><span class="co">#&gt; 1 1.194307e-04   0.04155578   0.22384625    -4.295713e-17     3.369023e-02</span></a>
<a class="sourceLine" id="cb9-42" title="42"><span class="co">#&gt; 2 1.067789e-02   0.18437013   3.40574883     8.817155e-02     3.014982e-02</span></a>
<a class="sourceLine" id="cb9-43" title="43"><span class="co">#&gt; 3 3.236282e-03   0.02386048   2.02252364    -1.234653e-17     3.888620e-05</span></a>
<a class="sourceLine" id="cb9-44" title="44"><span class="co">#&gt; 4 2.819817e-06   0.02607755   0.12956621     2.004049e-02     9.976858e-01</span></a>
<a class="sourceLine" id="cb9-45" title="45"><span class="co">#&gt; 5 3.565177e-04   0.10007273   0.08271719     1.027663e-17    -1.464205e-16</span></a>
<a class="sourceLine" id="cb9-46" title="46"><span class="co">#&gt; 6 5.889038e-03   1.37781401   4.11156951     3.456103e-01     6.319632e-01</span></a>
<a class="sourceLine" id="cb9-47" title="47"><span class="co">#&gt;   pixel_class</span></a>
<a class="sourceLine" id="cb9-48" title="48"><span class="co">#&gt; 1    spheroid</span></a>
<a class="sourceLine" id="cb9-49" title="49"><span class="co">#&gt; 2          bg</span></a>
<a class="sourceLine" id="cb9-50" title="50"><span class="co">#&gt; 3          bg</span></a>
<a class="sourceLine" id="cb9-51" title="51"><span class="co">#&gt; 4    spheroid</span></a>
<a class="sourceLine" id="cb9-52" title="52"><span class="co">#&gt; 5          bg</span></a>
<a class="sourceLine" id="cb9-53" title="53"><span class="co">#&gt; 6    spheroid</span></a></code></pre></div>
<p>In this case it would be a increase in 1.2380952 times of computation.</p>
<p>Preprocessing functions can be much more complicated …</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">preprocess_img &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb10-2" title="2">    x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/correct_light.html">correct_light</a></span>(x, <span class="dt">chunk_width =</span> <span class="dv">11</span>)</a>
<a class="sourceLine" id="cb10-3" title="3">    x &lt;-<span class="st"> </span><span class="kw">half_image</span>(x)</a>
<a class="sourceLine" id="cb10-4" title="4">    x &lt;-<span class="st"> </span>x <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(x), <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-5" title="5">    x &lt;-<span class="st"> </span>x<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(x)</a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(x)</a>
<a class="sourceLine" id="cb10-7" title="7">}</a>
<a class="sourceLine" id="cb10-8" title="8"></a>
<a class="sourceLine" id="cb10-9" title="9">preprocessed_image &lt;-<span class="st"> </span><span class="kw">preprocess_img</span>(base_image)</a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw"><a href="https://rdrr.io/pkg/EBImage/man/display.html">display</a></span>(base_image, <span class="dt">method =</span> <span class="st">"raster"</span>)</a></code></pre></div>
<p><img src="time_performance_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="https://rdrr.io/pkg/EBImage/man/display.html">display</a></span>(preprocessed_image, <span class="dt">method =</span> <span class="st">"raster"</span>)</a></code></pre></div>
<p><img src="time_performance_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">multi_time_shrunk &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb12-2" title="2">    trainset_preproc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/build_train_multi.html">build_train_multi</a></span>(</a>
<a class="sourceLine" id="cb12-3" title="3">        params_df, </a>
<a class="sourceLine" id="cb12-4" title="4">        <span class="dt">preprocess_fun_img =</span> preprocess_img,</a>
<a class="sourceLine" id="cb12-5" title="5">        <span class="dt">preprocess_fun_mask =</span> half_image, </a>
<a class="sourceLine" id="cb12-6" title="6">        <span class="dt">train_size_each =</span> <span class="dv">1000</span>, </a>
<a class="sourceLine" id="cb12-7" title="7">        <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>),</a>
<a class="sourceLine" id="cb12-8" title="8">        <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">15</span>, <span class="dv">31</span>))</a>
<a class="sourceLine" id="cb12-9" title="9">})</a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">#&gt; Returning for file:  /tmp/Rtmpj1ueSh/temp_libpath734f364a36a4/clasifierrr/extdata/tiny_4T1-shNT-1_layer1.png and classification" spheroid " a total of { 1382 } positive pixels</span></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#&gt; Returning for file:  /tmp/Rtmpj1ueSh/temp_libpath734f364a36a4/clasifierrr/extdata/tiny_4T1-shNT-1_layer2.png and classification" bg " a total of { 2171 } positive pixels</span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#&gt; Classified objects are of classes {bg: 607} and {spheroid: 393}</span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#&gt; Returning a data frame of 1000 rows and 11 columns</span></a></code></pre></div>
</div>
<div id="precompilation-of-filters" class="section level1">
<h1 class="hasAnchor">
<a href="#precompilation-of-filters" class="anchor"></a>Precompilation of filters</h1>
<p>This section does not address per-se accelerating things but re-using sections of the functions when processing many images.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb13-3" title="3">  features &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_features.html">calc_features</a></span>(</a>
<a class="sourceLine" id="cb13-4" title="4">    base_image, </a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">11</span>,<span class="dv">15</span>),</a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">15</span>, <span class="dv">31</span>))</a>
<a class="sourceLine" id="cb13-7" title="7">}})</a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="co">#&gt;   3.391   0.014   3.451</span></a>
<a class="sourceLine" id="cb13-10" title="10"></a>
<a class="sourceLine" id="cb13-11" title="11">fft_image &lt;-<span class="st"> </span>fftwtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/fftwtools/man/fftw2d.html">fftw2d</a></span>(base_image)</a>
<a class="sourceLine" id="cb13-12" title="12">precompiled_filters &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_features.html">compile_calc_features</a></span>(</a>
<a class="sourceLine" id="cb13-13" title="13">  <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">11</span>,<span class="dv">15</span>),</a>
<a class="sourceLine" id="cb13-14" title="14">  <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">15</span>, <span class="dv">31</span>),</a>
<a class="sourceLine" id="cb13-15" title="15">  <span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(base_image))</a>
<a class="sourceLine" id="cb13-16" title="16"></a>
<a class="sourceLine" id="cb13-17" title="17"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb13-18" title="18"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb13-19" title="19">  features &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfc</a></span>(precompiled_filters, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">.x</span>(fft_image)))</a>
<a class="sourceLine" id="cb13-20" title="20">}})</a>
<a class="sourceLine" id="cb13-21" title="21"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb13-22" title="22"><span class="co">#&gt;   2.121   0.001   2.139</span></a></code></pre></div>
<p>Internally what happens is that, each image gets converted to fourer space, the filter is expanded to the size of the image and converted to fourier space. Multiplied (in fourier space) and the product of the two of them is then converted back to normal space.</p>
<p>Converting to fourier space is expensive, but if every filter will use the same converted image, that can be calculated once and saved. In the same way, if a filter will be used many times (on images the same size), it can be calculated and used many times.</p>
</div>
<div id="parallel-processing" class="section level1">
<h1 class="hasAnchor">
<a href="#parallel-processing" class="anchor"></a>Parallel processing</h1>
<p>Some of the internals of the functions that calculate many filters are based on the <code>future</code> package, which allows one to run them in parallel.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span>(future)</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">#&gt; Loading required package: future</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="kw"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span>(multiprocess, <span class="dt">workers =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">#&gt; Warning: [ONE-TIME </span><span class="al">WARNING</span><span class="co">] Forked processing ('multicore') is disabled</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co">#&gt; in future (&gt;= 1.13.0) when running R from RStudio, because it is</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">#&gt; considered unstable. Because of this, plan("multicore") will fall</span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="co">#&gt; back to plan("sequential"), and plan("multiprocess") will fall back to</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co">#&gt; plan("multisession") - not plan("multicore") as in the past. For more details,</span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co">#&gt; how to control forked processing or not, and how to silence this warning in</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="co">#&gt; future R sessions, see ?future::supportsMulticore</span></a>
<a class="sourceLine" id="cb14-11" title="11"></a>
<a class="sourceLine" id="cb14-12" title="12">features &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_features.html">calc_features</a></span>(</a>
<a class="sourceLine" id="cb14-13" title="13">  base_image, </a>
<a class="sourceLine" id="cb14-14" title="14">  <span class="dt">filter_widths =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">11</span>,<span class="dv">15</span>),</a>
<a class="sourceLine" id="cb14-15" title="15">  <span class="dt">shape_sizes =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">15</span>, <span class="dv">31</span>))</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#image-pre-processing">Image Pre-processing</a></li>
      <li><a href="#precompilation-of-filters">Precompilation of filters</a></li>
      <li><a href="#parallel-processing">Parallel processing</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by J Sebastian Paez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
